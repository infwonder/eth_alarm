<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
      <title>Ethereum Alarm Clock</title>
      <link rel="stylesheet" href="css/style.css">
    <script>
      var Web3 = require('web3');
      var net  = require('net');
      var web3 = new Web3();
      web3.setProvider(new Web3.providers.HttpProvider('http://127.0.0.1:8545'));
      web3.getTransactionReceiptMined = require('./js/libs/txReceiptMined.js');
    </script>
</head>

<body>
<!-- particles.js container --> 
    <div id="particle"></div>
    <div id="overlay">
      <table align=center style="margin-top: 40px; margin-bottom: 20px"> 
      <tr>
        <td colspan=3 align="center">
          <dl>
             <dt>Local Time (UNIX Epoch): </dt><dd id="txt"></dd>
          </dl>
        </td>
      </tr>
      <tr>
        <td align="center">
          <dl>
            <dt>ETH Block: </dt><dd id="eth"></dd>
          </dl>
        </td>
        <td colspan=2 align="center">
          <dl>
            <dt>Block Timestamp: </dt><dd id="epo"></dd>
          </dl>
        </td>
      </tr>
      <tr>
        <td colspan=3 align="center">
          <dl>
            <dt>Set Alarm on ETH Block: </dt>
            <dd>
              <form onsubmit="setAlarm()" style="text-align: center">
                <label for="setBlock">Eth Block:</label><input type="text" id="setBlock"><br>
                <label for="fromAddr">From:</label><input type="text" id="fromAddr" size="64"><br>
                <label for="toAddr">To:</label><input type="text" id="toAddr" size="64"><br>
                <label for="valueEth">Ether:</label><input type="text" id="valueEth"><br>
                <label for="gasLimit">Gas Limit:</label><input type="text" id="gasLimit"><br>
                <label for="gasPrice">Gas Price:</label><input type="text" id="gasPrice"><br>
                <label for="password">Password:</label><input type="password" id="password"><br>
                <input id="reset" type="submit" value="reset">
              </form>
            </dd>
          </dl>
        </td>
      </tr>
      <tr><td align="center" colspan=3><h2 style="color: #ffffff;" id=received>No Alarm Set ...</h2></td></tr>
      </table>
    </div>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="js/index.js"></script>
    <script>
    var t;
    var fired = false; 

    function startTime() {
        var today = new Date();
        var h = prefix(today.getHours());
        var m = prefix(today.getMinutes());
        var s = prefix(today.getSeconds());
        var u = today.getTime()/1000|0;

        var trigger = document.getElementById('setBlock').value;
        var b = web3.eth.blockNumber;

        if (trigger) 
        { 
            if (b == trigger && !fired) 
            { 
                fired = true;
                var txObj = 
                {
                   from: document.getElementById('fromAddr').value.toString(),
                     to: document.getElementById('toAddr').value.toString(),
                  value: web3.toWei(document.getElementById('valueEth').value, 'ether'),
                    gas: document.getElementById('gasLimit').value.toString() || "200000",
                  gasPrice: document.getElementById('gasPrice').value.toString() || "50000000000"
                };

                var ipc3 = new Web3();
                ipc3.setProvider(new Web3.providers.IpcProvider('/home/jasonlin/.ethereum/geth.ipc', net));
                ipc3.unlockToPay = require('./js/libs/unlockViaIPC.js'); 

                ipc3.unlockToPay(txObj, document.getElementById('password').value.toString(), web3)
                .then((tx) =>
                {

                  document.getElementById('received').innerHTML = "txhash: " + tx;
                  ipc3.personal.lockAccount(txObj.from, (e,r) =>
                  {
                    if(e) throw(e);
                    ipc3.net._requestManager.provider.connection.destroy();
                  });
                  return tx;
                 })
                .then((txhash) =>
                {
                  return web3.getTransactionReceiptMined(txhash, 500);
                })
                .then((r) => { document.getElementById('received').innerHTML = "Transaction " + r.transactionHash + " is mined on block " + r.blockNumber })
                .catch((err) => { console.log("error: " + err); });
            } else if(b < trigger) {
                document.getElementById('received').innerHTML = "Alarm Set at ETH Block: " + trigger;
            }
        } else {
            document.getElementById('received').innerHTML = "No Alarm Set ...";
        }

        document.getElementById('txt').innerHTML = h + ":" + m + ":" + s + " (" + u + ")";
        document.getElementById('epo').innerHTML = web3.eth.getBlock('latest').timestamp;
        document.getElementById('eth').innerHTML = web3.eth.blockNumber;

        t = setTimeout(startTime, 250);
    }

    function prefix(i) {
        if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
        return i;
    }

    function setAlarm() {
        var trigger = document.getElementById("setBlock");
        return false;
    }

    document.onload = startTime();
    </script>
</body>
</html>
